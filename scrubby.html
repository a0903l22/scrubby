<!doctype html>
<style>
  .scrub {
    cursor: ew-resize;
    border-bottom: 1px dashed blue;
  }
  html.dragging {
    cursor: ew-resize;
  }
</style>
<script src='node_modules/esprima/esprima.js'></script>
<script src='node_modules/escodegen/escodegen.js'></script>
<script src='xform.js'></script>
<script>
function tag(name, text) {
  var parts = name.split(/(?=[.#])/); // why yes, i am a ninja
  var tagName = "div", id, classes = [];
  for (var i = 0; i < parts.length; i++) {
    var p = parts[i];
    if (p[0] === '#')
      id = p.substr(1);
    else if (p[0] === '.')
      classes.push(p.substr(1));
    else
      tagName = p;
  }
  var element = document.createElement(tagName);
  if (typeof id !== 'undefined')
    element.id = id;
  for (var i = 0; i < classes.length; i++) {
    element.classList.add(classes[i]);
  }
  if (text)
    element.innerText = text;
  return element;
}
</script>

<body>
  <pre id='code'>
    var elt = document.createElement("div")
    elt.style.background = 'green';
    elt.style.position = 'absolute';
    document.body.appendChild(elt);

    setInterval(updateStyle, 16)
    function updateStyle() {
      elt.style.width = 100 * 3 + 'px';
      elt.style.height = 100 + 'px';
      elt.style.left = 1 + 'px';
      elt.style.top = 1 + 'px';
    }
  </pre>

<script>
  var orig_code = code.innerText
  var xfmd = xform(code.innerText);
  var code_text = code.innerText
  var curpos = 0
  var newCode = tag('pre#code')
  for (var i in xfmd.values) {
    var val = xfmd.values[i]
    newCode.appendChild(document.createTextNode(
        code_text.substring(curpos, val.range[0])))
    var scrubber = newCode.appendChild(tag('span.scrub', val.value))
    scrubber.value_id = i
    curpos = val.range[1]
  }
  newCode.appendChild(document.createTextNode(
      code_text.substring(curpos)))
  code.parentNode.replaceChild(newCode, code)

  var iframe = tag('iframe')
  document.body.appendChild(iframe)
  iframe.contentWindow.eval(escodegen.generate(xfmd.ast));

  function onValueScrubbed() {
  }
  function attachScrubbers() {
    var scrubs = document.querySelectorAll('.scrub')
    for (var i = 0; i < scrubs.length; i++) {
      (function(s){
        s.addEventListener('mousedown', function(e) {
          e.preventDefault();
          var mx = e.pageX, my = e.pageY
          var originalValue = Number(s.innerText)
          document.documentElement.classList.add('dragging')

          window.addEventListener('mousemove', moved)
          function moved(e) {
            e.preventDefault();
            var d = Math.floor((e.pageX - mx)/2) + originalValue;
            s.innerText = d;
            iframe.contentWindow.$values[s.value_id] = d;
            onValueScrubbed();
          }
          window.addEventListener('mouseup', up);
          function up(e) {
            window.removeEventListener('mousemove', moved)
            window.removeEventListener('mouseup', up)
            document.documentElement.classList.remove('dragging')
          }
        });
      })(scrubs[i])
    }
  }
  attachScrubbers();
</script>
